---
phase: 01-foundation-security
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified: [security/container-profiles.json, security/hardening.yml, configs/podman-security.conf, scripts/cleanup.sh, services/container-cleanup.service]
autonomous: true

must_haves:
  truths:
    - "Containers run with minimal capabilities and no host access"
    - "System automatically cleans up stopped containers and unused resources"
    - "Container isolation prevents access to host filesystem and network"
  artifacts:
    - path: "security/container-profiles.json"
      provides: "Security profiles for container execution"
      contains: "cap-drop ALL"
    - path: "scripts/cleanup.sh"
      provides: "Automated resource cleanup"
      exports: ["cleanup", "prune"]
    - path: "services/container-cleanup.service"
      provides: "Systemd service for scheduled cleanup"
      contains: "ExecStart"
  key_links:
    - from: "security/container-profiles.json"
      to: "podman run"
      via: "security-opt flags"
      pattern: "--security-opt.*profile"
    - from: "scripts/cleanup.sh"
      to: "podman system prune"
      via: "automated cleanup execution"
      pattern: "podman.*prune"
---

<objective>
Implement comprehensive security hardening and automated resource management for container operations.

Purpose: Establishes secure container isolation and prevents resource accumulation through automated cleanup. Ensures containers cannot compromise host system security.
Output: Security profiles, hardening configurations, and automated cleanup system ready for challenge container deployment.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-security/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Create Security Hardening Configuration</name>
  <files>security/container-profiles.json, security/hardening.yml, configs/podman-security.conf</files>
  <action>
    Create security/container-profiles.json with security profiles based on research patterns:
    - Default profile: --cap-drop ALL, --security-opt no-new-privileges, --read-only filesystem
    - Challenge profile: minimal required capabilities (CHOWN, DAC_OVERRIDE only)
    - Rootless execution enforced (--user 1000:1000)
    - Tmpfs mounts for writable areas (/tmp with noexec, nosuid, size limits)

    Create security/hardening.yml with hardening measures:
    - SELinux/AppArmor configuration (use system default)
    - Namespace isolation settings
    - Resource limits (memory, CPU, PIDs)
    - Network restrictions (no host network access)

    Create configs/podman-security.conf for Podman daemon-less configuration:
    - Default security options for all containers
    - Rootless storage configuration
    - Log level and audit settings
    - Security profile enforcement
  </action>
  <verify>podman run --dry-run --security-opt profile=security/container-profiles.json alpine:latest echo "test"</verify>
  <done>Security configurations enforce rootless execution, minimal capabilities, and filesystem isolation</done>
</task>

<task type="auto">
  <name>Implement Resource Cleanup System</name>
  <files>scripts/cleanup.sh, services/container-cleanup.service</files>
  <action>
    Create scripts/cleanup.sh with comprehensive cleanup logic based on research patterns:
    - Stop and remove stopped containers older than 1 hour
    - Remove unused images not referenced by running containers
    - Prune volumes unused for 24 hours (preserve persistent data)
    - Clean build cache and temporary files
    - Log cleanup operations with timestamps
    - Safety checks to prevent deletion of active resources

    Create services/container-cleanup.service systemd unit file:
    - Scheduled execution every 4 hours
    - ExecStart pointing to cleanup script
    - Requires podman.service dependency
    - User-level service (no root required)
    - Logging to journal for audit trail

    Script should use safe podman commands:
    - podman system prune -f --filter "until=1h"
    - podman volume prune -f --filter "until=24h"
    - podman image prune -f --filter "dangling=true"
  </action>
  <verify>chmod +x scripts/cleanup.sh && ./scripts/cleanup.sh --dry-run</verify>
  <done>Cleanup system automatically manages container lifecycle and resource usage without impacting running services</done>
</task>

<task type="auto">
  <name>Validate Security Isolation</name>
  <files>scripts/security-test.sh</files>
  <action>
    Create scripts/security-test.sh to validate security measures:
    - Test container cannot access host filesystem outside allowed mounts
    - Verify containers run as non-root user (id returns 1000:1000)
    - Confirm minimal capability set (capsh --print shows only CHOWN, DAC_OVERRIDE)
    - Test network isolation (no access to host network interfaces)
    - Verify read-only filesystem enforcement (writes to / fail)
    - Check tmpfs mount restrictions (noexec prevents script execution)

    Test scenarios:
    - Attempt host filesystem escape (should fail)
    - Try privilege escalation (should fail)
    - Test container-to-container isolation
    - Verify resource limits enforcement
    - Confirm cleanup doesn't affect running containers
  </action>
  <verify>chmod +x scripts/security-test.sh && ./scripts/security-test.sh</verify>
  <done>Security tests confirm containers cannot access host system and operate with minimal privileges</done>
</task>

</tasks>

<verification>
- Security tests pass demonstrating container isolation
- Cleanup script successfully removes test containers and images
- `podman system info` shows rootless configuration
- Containers cannot write to read-only filesystem areas
- systemctl --user status container-cleanup shows service ready
</verification>

<success_criteria>
- **INFR-01**: Secure container isolation - verified by security test suite
- **INFR-05**: Advanced security hardening - implemented through security profiles and configurations
- **CHAL-09**: Disposable container architecture - enabled by automated cleanup system
- **INFR-02**: Resource management - implemented through cleanup service and resource limits
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-02-SUMMARY.md`
</output>