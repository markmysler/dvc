---
phase: 01-foundation-security
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified: [monitoring/prometheus.yml, monitoring/grafana/dashboards/containers.json, monitoring/node-exporter.service, scripts/monitoring-setup.sh]
autonomous: true

must_haves:
  truths:
    - "System provides real-time monitoring of container resource usage"
    - "Platform tracks container lifecycle events and system performance"
    - "Monitoring data persists locally without external dependencies"
  artifacts:
    - path: "monitoring/prometheus.yml"
      provides: "Metrics collection configuration"
      contains: "node_exporter"
    - path: "monitoring/grafana/dashboards/containers.json"
      provides: "Container monitoring dashboard"
      min_lines: 50
    - path: "scripts/monitoring-setup.sh"
      provides: "Monitoring stack initialization"
      exports: ["start", "stop", "status"]
  key_links:
    - from: "monitoring/prometheus.yml"
      to: "node_exporter"
      via: "scrape_configs targets"
      pattern: "targets.*localhost.*9100"
    - from: "monitoring/grafana/dashboards/"
      to: "prometheus datasource"
      via: "prometheus query expressions"
      pattern: "expr.*prometheus.*query"
---

<objective>
Establish comprehensive monitoring and logging for container operations and system performance.

Purpose: Provides visibility into container resource usage, system health, and platform performance. Enables detection of resource issues and optimization opportunities.
Output: Complete monitoring stack with Prometheus metrics collection, Grafana visualization, and local data persistence.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-security/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Configure Prometheus Metrics Collection</name>
  <files>monitoring/prometheus.yml, monitoring/node-exporter.service</files>
  <action>
    Create monitoring/prometheus.yml configuration based on research patterns:
    - Scrape intervals: 15s for containers, 30s for system metrics
    - Targets: node_exporter (system metrics), container runtime metrics
    - Retention: 30 days local storage in monitoring/data/prometheus
    - Recording rules for container CPU, memory, network usage
    - Alert rules for resource thresholds (80% memory, high CPU)

    Create monitoring/node-exporter.service systemd unit:
    - User-level service for host metrics collection
    - Bind to localhost:9100 (no external exposure)
    - Minimal privileges for metrics collection only
    - Restart policy for reliability
    - Log to systemd journal

    Configure scraping targets:
    - node_exporter: system and host metrics
    - podman metrics endpoint (if available)
    - Application-level metrics (future container workloads)
    - Local filesystem and network metrics only
  </action>
  <verify>systemctl --user start node_exporter && curl -s localhost:9100/metrics | grep "node_" | head -5</verify>
  <done>Prometheus collects system and container metrics locally with proper retention and alerting</done>
</task>

<task type="auto">
  <name>Create Grafana Monitoring Dashboard</name>
  <files>monitoring/grafana/dashboards/containers.json, monitoring/grafana/provisioning/datasources/prometheus.yml</files>
  <action>
    Create monitoring/grafana/dashboards/containers.json with comprehensive container monitoring:
    - Container resource usage (CPU, memory, network, disk I/O)
    - System overview (load average, disk space, memory utilization)
    - Container lifecycle events (starts, stops, failures)
    - Security events (failed isolation attempts, capability violations)
    - Performance metrics (response times, throughput)

    Create monitoring/grafana/provisioning/datasources/prometheus.yml:
    - Local Prometheus endpoint configuration
    - No external data sources or cloud connections
    - Read-only access to metrics data
    - Proper authentication for local access

    Dashboard features:
    - Real-time updates with 5-second refresh
    - Time range selector (1h, 6h, 24h, 7d)
    - Alert annotations and threshold visualization
    - Container filtering and grouping
    - Resource efficiency analysis panels
  </action>
  <verify>ls monitoring/grafana/dashboards/containers.json && grep -q "prometheus" monitoring/grafana/provisioning/datasources/prometheus.yml</verify>
  <done>Grafana dashboard provides comprehensive container and system monitoring with local data sources</done>
</task>

<task type="auto">
  <name>Implement Monitoring Automation</name>
  <files>scripts/monitoring-setup.sh, scripts/monitoring-health.sh</files>
  <action>
    Create scripts/monitoring-setup.sh with monitoring stack management:
    - Start/stop/restart monitoring services (Prometheus, Grafana, node_exporter)
    - Initialize monitoring data directories with proper permissions
    - Configure Grafana admin user and dashboard provisioning
    - Verify service health and connectivity
    - Import default dashboards and configure alerts

    Create scripts/monitoring-health.sh for health checking:
    - Test Prometheus scraping endpoints
    - Verify Grafana dashboard loading
    - Check data retention and storage usage
    - Validate alert rule evaluation
    - Monitor service resource consumption

    Integration with main setup:
    - Add monitoring commands to package.json scripts
    - Include monitoring services in docker-compose.yml
    - Add monitoring health checks to verification script
    - Configure log rotation for monitoring services
  </action>
  <verify>chmod +x scripts/monitoring-setup.sh && ./scripts/monitoring-setup.sh status</verify>
  <done>Monitoring automation manages full monitoring stack lifecycle with health checking and maintenance</done>
</task>

</tasks>

<verification>
- Prometheus UI accessible at localhost:9090 showing metrics
- Grafana UI accessible at localhost:3000 with container dashboard
- node_exporter provides system metrics (check /metrics endpoint)
- No external network connections from monitoring stack
- Monitoring data persists in local directories
</verification>

<success_criteria>
- **INFR-03**: Basic monitoring and logging - implemented with Prometheus/Grafana stack
- **INFR-06**: Performance optimization features - enabled through monitoring and alerting
- Monitoring operates entirely locally supporting overall platform isolation
- Foundation established for container lifecycle tracking in future phases
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-03-SUMMARY.md`
</output>